---
title: "Testing Lahman 6.0"
author: "Martin Monkman"
date: "2017-07-17"
output: html_notebook
---

This markdown document incorporates a variety of short scripts that draw on the various tables in the `Lahman` package. (See the Lahman project page on RForge for more details <http://lahman.r-forge.r-project.org/>.)

Note that some of scripts appear in the documentation of other R packages; in those cases, the original source is noted prior to the script.

First of all, install and load the new version of `Lahman`, and load the `tidyverse` package.

```{r}
# install.packages("Lahman", repos="http://R-Forge.R-project.org")

devtools::install_github("cdalzell/Lahman", ref="develop")
library(Lahman)

library(tidyverse)
#
```


##Master & Fielding

This uses an inner join to merge the two tables `Master` and `Fielding` into a new data frame "MasterFielding".  The first approach relies on the `merge` instruction, while the second uses the much faster `inner_join` command from `dplyr`.


```{r}
# throwing by position
# version 1 - "merge"
MasterFielding <- data.frame(merge(Master, Fielding, by="playerID"))
MasterFielding <- merge(Master, Fielding, by="playerID")
system.time(MasterFielding <- merge(Master, Fielding, by="playerID"))
# the dplyr version -- faster
MasterFielding <- inner_join(Fielding, Master, by="playerID")
system.time(MasterFielding <- inner_join(Fielding, Master, by="playerID"))
#
#
# a count of games played, by position
MasterFielding <- subset(MasterFielding, POS != "OF" & yearID > "1944")
#
MasterFielding %>%
  group_by(playerID, POS, throws) %>%
  summarise(gamecount = sum(G)) %>%
  arrange(desc(gamecount)) %>% 
  head(5)
#
MasterFielding <- inner_join(Fielding, Master, by="playerID")
# select only those seasons since 1945 and 
# omit the records that are OF summary (i.e. leave the RF, CF, and LF)
MasterFielding <- subset(MasterFielding, POS != "OF" & yearID > "1944")
#
```

Now with the MasterFielding table, we can use the `summarise` command (`dplyr`) to generate a new table, "Player_games", that in turn is summarised into a table counting the games played at each position.

```{r}

Player_games <- MasterFielding %>%
  group_by(playerID, POS, throws) %>%
  summarise(gamecount = sum(G))
Player_POS <- Player_games %>%
  group_by(POS, throws) %>%
  summarise(playercount = length(gamecount))
head(Player_POS)
#

```

## Batting (dplyr reference)

This chunk of code is lifted straight from the "Data transformatin" chapter of the online version of the book [_R for Data Science_](http://r4ds.had.co.nz/transform.html) by Garret Grolemund and Hadley Wickham (Specifically, section 5.6.3.


```{r}

# Convert to a tibble so it prints nicely
batting <- as_tibble(Lahman::Batting)

batters <- batting %>% 
  group_by(playerID) %>% 
  summarise(
    ba = sum(H, na.rm = TRUE) / sum(AB, na.rm = TRUE),
    ab = sum(AB, na.rm = TRUE)
  )

batters %>% 
  filter(ab > 100) %>% 
  ggplot(mapping = aes(x = ab, y = ba)) +
    geom_point() + 
    geom_smooth(se = FALSE)
#> `geom_smooth()` using method = 'gam'
```

A second chunk from _R for Data Science_ (same section).

```{r}

batters %>% 
  arrange(desc(ba))
#> # A tibble: 18,659 Ã— 3
#>    playerID    ba    ab
#>       <chr> <dbl> <int>
#> 1 abramge01     1     1
#> 2 banisje01     1     1
#> 3 bartocl01     1     1
#> 4  bassdo01     1     1
#> 5 birasst01     1     2
#> 6 bruneju01     1     1
#> # ... with 1.865e+04 more rows

```



`dplyr` [Vignettes page](http://cran.r-project.org/web/packages/dplyr/vignettes/databases.html), under the topic "Postgresql". NOTE: the package `postgres` is not available for R 3.1.1


## Reference list
[Lahman at CRAN](http://cran.r-project.org/web/packages/Lahman/index.html)

[Lahman at RForge](http://lahman.r-forge.r-project.org/)

### dplyr

[dplyr at CRAN](http://cran.r-project.org/web/packages/dplyr/index.html)

[dplyr: Introduction to dplyr (at CRAN)](http://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html)

[dplyr: Vignettes](http://cran.r-project.org/web/packages/dplyr/vignettes/databases.html)